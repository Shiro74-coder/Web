<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <title>Products (GraphQL)</title>
  <style>
    body {font-family: system-ui, sans-serif; margin: 24px;}
    table {border-collapse: collapse; width: 100%;}
    th, td {border: 1px solid #ddd; padding: 8px;}
    th {text-align:left;}
    .controls {display:flex; gap:12px; margin: 12px 0;}
  </style>
</head>
<body>
  <h1>Danh sách sản phẩm (giá ↑)</h1>
  <div class="controls">
    <button id="btnLoad">Tải danh sách</button>
    <label>Category ID: <input id="catId" type="number" min="1" style="width:90px"></label>
    <button id="btnByCat">Lấy theo Category</button>
  </div>
  <table id="tbl"><thead>
    <tr><th>ID</th><th>Title</th><th>Price</th><th>Categories</th><th>User</th></tr>
  </thead><tbody></tbody></table>

<script>
async function gql(query, variables={}) {
  const res = await fetch('/graphql', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ query, variables })
  });
  const json = await res.json();
  if (json.errors) { console.error(json.errors); alert('GraphQL error. Check console.'); }
  return json.data;
}
function render(rows) {
  const tb = document.querySelector('#tbl tbody');
  tb.innerHTML = (rows||[]).map(p => `
    <tr>
      <td>${p.id}</td>
      <td>${p.title}</td>
      <td>${p.price}</td>
      <td>${(p.categories||[]).map(c=>c.name).join(', ')}</td>
      <td>${p.user?.fullname ?? ''}</td>
    </tr>`).join('');
}
document.querySelector('#btnLoad').onclick = async () => {
  const q = `query { productsSortedByPriceAsc {
    id title price categories{ name } user{ fullname } } }`;
  const data = await gql(q);
  render(data?.productsSortedByPriceAsc);
};
document.querySelector('#btnByCat').onclick = async () => {
  const cid = Number(document.querySelector('#catId').value);
  if (!cid) return alert('Nhập Category ID');
  const q = `query($cid: ID!) { productsByCategoryId(categoryId: $cid) {
    id title price categories{ name } user{ fullname } } }`;
  const data = await gql(q, { cid });
  render(data?.productsByCategoryId);
};
</script>
</body>
</html>
